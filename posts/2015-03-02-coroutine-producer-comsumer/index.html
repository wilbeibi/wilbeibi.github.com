<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Producer consumer problem in coroutine - Gradient Ascent</title><meta name=description content="what coroutine is and a sample code of producer consumer problem."><meta property="og:title" content="Producer consumer problem in coroutine"><meta property="og:description" content="what coroutine is and a sample code of producer consumer problem."><meta property="og:type" content="article"><meta property="og:url" content="https://wilbeibi.com/posts/2015-03-02-coroutine-producer-comsumer/"><meta property="og:site_name" content="Gradient Ascent"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2015-03-02T00:00:00Z"><meta property="article:modified_time" content="2026-02-16T16:16:06-08:00"><meta property="article:author" content="wilbeibi"><meta property="article:tag" content="python"><meta name=twitter:card content="summary"><meta name=twitter:title content="Producer consumer problem in coroutine"><meta name=twitter:description content="what coroutine is and a sample code of producer consumer problem."><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel="shortcut icon" href=/favicon.ico><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;0,700;1,400;1,700&family=JetBrains+Mono:wght@400;700&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.7.0/style.css rel=stylesheet><link rel=canonical href=https://wilbeibi.com/posts/2015-03-02-coroutine-producer-comsumer/><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/instantsearch.css@7.4.5/themes/satellite-min.css><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"\"Producer consumer problem in coroutine\"","description":"\"what coroutine is and a sample code of producer consumer problem.\"","datePublished":"2015-03-02T00:00:00Z","dateModified":"2026-02-16T16:16:06-08:00","author":{"@type":"Person","name":"\"wilbeibi\"","url":"https:\/\/wilbeibi.com\/"},"publisher":{"@type":"Person","name":"\"wilbeibi\""},"mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/wilbeibi.com\/posts\/2015-03-02-coroutine-producer-comsumer\/"},"keywords":"[\"python\"]"}</script></head><body><div class=container><div class=header><a href=/>wilbeibi</a>'s Gradient Ascent</div><div class=navigation><ul><li><a href=/>Home</a></li><li><a href=/posts/>Archive</a></li><li><a href=/tags/>Tags</a></li><li><a href=/pages/about/>About</a></li></ul></div><div class=body><h1>Producer consumer problem in coroutine</h1><p class=date>written on March 02, 2015 · 2 min read</p><h2 id=what-is-coroutine>What is coroutine</h2><p>As the name implies, coroutine refers to co-operative routine. It allows you to suspending and resuming execution at different locations. So, it&rsquo;s essentially just context switching. Not surprisingly, coroutine is implemented in primitives like setjmp/longjump or ucontext in low level.</p><p>In many senarioes, coroutine is a more light-weight alternative of threads. For programming languages with GIL (like Python), coroutine would used to handle concurrency.</p><h2 id=producer-and-consumer-problem>Producer and consumer problem</h2><p>Let&rsquo;s take a look at classic &ldquo;producer-consumer&rdquo; problem. At each time, one coroutine produce products and add them into queue, the other coroutine take products from queue and use it (hmm, sounds like video buffering, right?).</p><p>The code below assumes you already have some knowledge of generator.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>time</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>import</span> <span style=color:#24292e>random</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>coroutine</span><span style=color:#1f2328>(</span>func<span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># A wrapper to convert function into generator</span>
</span></span><span style=display:flex><span>    <span style=color:#57606a># From David Beazley</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>def</span> <span style=color:#6639ba>start</span><span style=color:#1f2328>(</span><span style=color:#0550ae>*</span>args<span style=color:#1f2328>,</span><span style=color:#0550ae>**</span>kwargs<span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>        cr <span style=color:#0550ae>=</span> func<span style=color:#1f2328>(</span><span style=color:#0550ae>*</span>args<span style=color:#1f2328>,</span><span style=color:#0550ae>**</span>kwargs<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        cr<span style=color:#0550ae>.</span>next<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>return</span> cr
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> start  
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>producer</span><span style=color:#1f2328>(</span>target<span style=color:#1f2328>):</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>while</span> <span style=color:#cf222e>True</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        time<span style=color:#0550ae>.</span>sleep<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        data <span style=color:#0550ae>=</span> random<span style=color:#0550ae>.</span>randint<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span> <span style=color:#0550ae>10</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#6639ba>print</span> <span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;# producer: sending data </span><span style=color:#0a3069>{}</span><span style=color:#0a3069>&#34;</span><span style=color:#0550ae>.</span>format<span style=color:#1f2328>(</span>data<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span>        target<span style=color:#0550ae>.</span>send<span style=color:#1f2328>(</span>data<span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#0550ae>@coroutine</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>def</span> <span style=color:#6639ba>consumer</span><span style=color:#1f2328>():</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>while</span> <span style=color:#cf222e>True</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>        data <span style=color:#0550ae>=</span> <span style=color:#cf222e>yield</span>
</span></span><span style=display:flex><span>        <span style=color:#6639ba>print</span> <span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;# consumer: receving data </span><span style=color:#0a3069>{}</span><span style=color:#0a3069>&#34;</span><span style=color:#0550ae>.</span>format<span style=color:#1f2328>(</span>data<span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span><span style=color:#cf222e>if</span> <span style=color:#953800>__name__</span> <span style=color:#0550ae>==</span> <span style=color:#0a3069>&#39;__main__&#39;</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>    g_consumer <span style=color:#0550ae>=</span> consumer<span style=color:#1f2328>()</span>
</span></span><span style=display:flex><span>    producer<span style=color:#1f2328>(</span>g_consumer<span style=color:#1f2328>)</span>
</span></span></code></pre></div><p>Simple enough, <code>send()</code> is a built-in function of generator. The producer send data to consumer, consumer receives data from <code>yield</code>.</p><h2 id=coroutine-usage>Coroutine usage</h2><p>Yes, the famous concurrency library gevent is based on coroutine.</p><h2 id=reference-and-recommended-reading>Reference and Recommended Reading:</h2><p><a href=https://www.python.org/dev/peps/pep-0342/>PEP 342: Coroutines via Enhanced Generators</a></p><p><a href=http://coolshell.cn/articles/10975.html>一个“蝇量级” C 语言协程库</a></p><p><a href=http://learn-gevent-socketio.readthedocs.org/en/latest/general_concepts.html>General concepts: concurrency, parallelism, threads and processes</a></p><p><a href=http://www.dabeaz.com/coroutines/>A Curious Course on Coroutines and Concurrency</a></p><div class=post-tags><a href=https://wilbeibi.com/tags/python/>python</a></div></div><div class=footer><p>Design by <a href=https://github.com/mitsuhiko/lucumr>Armin Ronacher</a>.</p><p>Subscribe via <a href=https://wilbeibi.com/index.xml>RSS</a>.</p></div></div></body></html>